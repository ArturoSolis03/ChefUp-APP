pipeline {
  agent any

  stages {
    stage('Clonar Repositorio') {
      steps {
        git branch: 'backend', url: 'https://github.com/ArturoSolis03/ChefUp-APP.git'
      }
    }

    stage('Build Auth Service') {
      steps {
        dir('auth-service') {
          sh 'docker build -t auth-service .'
        }
      }
    }

    stage('Build Favorites Service') {
      steps {
        dir('favorites-service') {
          sh 'docker build -t favorites-service .'
        }
      }
    }

    stage('Run Containers') {
      steps {
        sh '''
          docker stop auth-service || true && docker rm auth-service || true
          docker stop favorites-service || true && docker rm favorites-service || true

          docker run -d --name auth-service -p 3000:3000 --env-file auth-service/.env auth-service
          docker run -d --name favorites-service -p 3001:3001 --env-file favorites-service/.env favorites-service
        '''
      }
    }
  }

  post {
    success {
      echo '✅ Microservicios desplegados localmente en EC2 con Docker.'
    }
    failure {
      echo '❌ Falló el despliegue en EC2.'
    }
  }
}